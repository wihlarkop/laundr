---
import Layout from "../../layouts/Layout.astro";
import symbolsData from "../../data/symbols.json";
import type { LaundrySymbol } from "../../utils/engine";
import { languages } from "../../i18n/ui";
import { useTranslations } from "../../i18n/utils";

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params as { lang: keyof typeof languages };
const t = useTranslations(lang);
const symbols = symbolsData as unknown as LaundrySymbol[];
const categories = [...new Set(symbols.map((s) => s.category))];
---

<Layout title={`Laundr | ${t("dict.title")}`} lang={lang}>
    <div
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 w-full flex flex-col lg:flex-row gap-8"
    >
        <!-- Sidebar (Desktop) / Category Scroller (Mobile) -->
        <aside class="w-full lg:w-64 shrink-0">
            <div class="sticky top-20 space-y-6">
                <div class="hidden lg:block">
                    <h3
                        class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 px-4"
                    >
                        Categories
                    </h3>
                    <nav class="space-y-1">
                        {
                            categories.map((cat) => (
                                <button
                                    data-category={cat}
                                    class="cat-btn w-full text-left px-4 py-3 rounded-xl text-sm font-semibold text-slate-600 hover:bg-slate-100 transition-all"
                                >
                                    {t(`nav.${cat}` as any)}
                                </button>
                            ))
                        }
                    </nav>
                </div>

                <!-- Mobile Category Scroller -->
                <div
                    class="lg:hidden -mx-4 px-4 overflow-x-auto no-scrollbar flex gap-2"
                >
                    {
                        categories.map((cat) => (
                            <button
                                data-category={cat}
                                class="cat-btn-mobile whitespace-nowrap px-6 py-2 bg-white border border-slate-200 text-slate-500 rounded-full text-xs font-bold transition-all active:scale-95"
                            >
                                {t(`nav.${cat}` as any)}
                            </button>
                        ))
                    }
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="grow space-y-8">
            <header>
                <h2 class="text-3xl font-bold text-slate-900 mb-2">
                    {t("dict.title")}
                </h2>
                <p class="text-slate-500">{t("dict.subtitle")}</p>
            </header>

            <!-- Search Bar -->
            <div class="relative group">
                <div
                    class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="2"
                        stroke="currentColor"
                        class="w-5 h-5 text-slate-400 group-focus-within:text-blue-500 transition-colors"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
                        ></path>
                    </svg>
                </div>
                <input
                    type="text"
                    id="search-input"
                    placeholder={t("dict.search")}
                    class="grow pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all shadow-sm"
                />
            </div>

            <!-- Symbol Grid -->
            <div
                id="symbol-grid"
                class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"
            >
                {
                    symbols.map((symbol, index) => (
                        <article
                            data-symbol-id={symbol.id}
                            data-category={symbol.category}
                            data-search={`${symbol.label[lang as "en" | "id"]} ${symbol.description?.[lang as "en" | "id"] || ""}`}
                            class="symbol-card group bg-white border border-slate-200 rounded-2xl p-6 hover:border-blue-500 hover:shadow-xl hover:shadow-blue-500/5 transition-all flex flex-col"
                        >
                            <div class="flex items-start gap-5 mb-6">
                                <div class="w-16 h-16 bg-slate-50 rounded-xl flex items-center justify-center group-hover:bg-blue-50 transition-colors shrink-0">
                                    <img
                                        src={`/symbols/${symbol.id}.svg`}
                                        alt={symbol.label[lang as "en" | "id"]}
                                        width="40"
                                        height="40"
                                        loading={index >= 6 ? "lazy" : "eager"}
                                        class="w-10 h-10 opacity-80 group-hover:opacity-100 transition-opacity"
                                    />
                                </div>
                                <div class="min-w-0">
                                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-1">
                                        {t(`nav.${symbol.category}` as any)}
                                    </h4>
                                    <h3 class="text-lg font-bold text-slate-900 leading-tight group-hover:text-blue-600 transition-colors">
                                        {symbol.label[lang as "en" | "id"]}
                                    </h3>
                                </div>
                            </div>

                            <p class="text-sm text-slate-600 leading-relaxed mb-6">
                                {symbol.description?.[lang as "en" | "id"] ||
                                    t("results.empty.subtitle")}
                            </p>

                            {symbol.tip && (
                                <div class="mt-auto bg-blue-50/50 rounded-xl p-4 border border-blue-100/50">
                                    <span class="block text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-1.5 flex items-center gap-1.5">
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20"
                                            fill="currentColor"
                                            class="w-3 h-3"
                                        >
                                            <path
                                                fill-rule="evenodd"
                                                d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a.75.75 0 0 0 0 1.5h.253a.25.25 0 0 1 .244.304l-.459 2.066A1.75 1.75 0 0 0 10.747 15H11a.75.75 0 0 0 0-1.5h-.253a.25.25 0 0 1-.244-.304l.459-2.066A1.75 1.75 0 0 0 9.253 9H9Z"
                                                clip-rule="evenodd"
                                            />
                                        </svg>
                                        {t("dict.pro_tip")}
                                    </span>
                                    <p class="text-xs font-medium text-slate-700 italic">
                                        “{symbol.tip[lang as "en" | "id"]}”
                                    </p>
                                </div>
                            )}
                        </article>
                    ))
                }
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden py-20 text-center">
                <div
                    class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="w-8 h-8"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
                        ></path>
                    </svg>
                </div>
                <h4 class="text-slate-900 font-bold mb-1">{t("dict.empty")}</h4>
            </div>
        </main>
    </div>

    <script>
        const searchInput = document.getElementById(
            "search-input",
        ) as HTMLInputElement;
        const symbolCards = document.querySelectorAll(".symbol-card");
        const catButtons = document.querySelectorAll(
            ".cat-btn, .cat-btn-mobile",
        );
        const emptyState = document.getElementById("empty-state");
        const grid = document.getElementById("symbol-grid");

        let activeCategory: string | null = null; // null means show all
        let searchQuery = "";

        function filterSymbols() {
            let visibleCount = 0;
            symbolCards.forEach((card) => {
                const htmlCard = card as HTMLElement;
                const category = htmlCard.dataset.category;
                const searchText = htmlCard.dataset.search?.toLowerCase() || "";

                const matchesCategory =
                    activeCategory === null || category === activeCategory;
                const matchesSearch = searchText.includes(
                    searchQuery.toLowerCase(),
                );

                if (matchesCategory && matchesSearch) {
                    htmlCard.style.display = "flex";
                    visibleCount++;
                } else {
                    htmlCard.style.display = "none";
                }
            });

            if (emptyState && grid) {
                if (visibleCount === 0) {
                    emptyState.classList.remove("hidden");
                    grid.classList.add("hidden");
                } else {
                    emptyState.classList.add("hidden");
                    grid.classList.remove("hidden");
                }
            }
        }

        searchInput?.addEventListener("input", (e) => {
            searchQuery = (e.target as HTMLInputElement).value;
            filterSymbols();
        });

        catButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const cat = (btn as HTMLElement).dataset.category;

                // Toggle behavior: if clicking active category, deactivate it
                if (activeCategory === cat) {
                    activeCategory = null; // Show all
                } else {
                    activeCategory = cat || null;
                }

                // Update all button styles
                catButtons.forEach((b) => {
                    const btnCat = (b as HTMLElement).dataset.category;
                    const isActive = btnCat === activeCategory;
                    const isDesktop = b.classList.contains("cat-btn");

                    if (isDesktop) {
                        if (isActive) {
                            b.classList.add(
                                "bg-blue-600",
                                "text-white",
                                "shadow-lg",
                                "shadow-blue-500/20",
                            );
                            b.classList.remove(
                                "text-slate-600",
                                "hover:bg-slate-100",
                            );
                        } else {
                            b.classList.remove(
                                "bg-blue-600",
                                "text-white",
                                "shadow-lg",
                                "shadow-blue-500/20",
                            );
                            b.classList.add(
                                "text-slate-600",
                                "hover:bg-slate-100",
                            );
                        }
                    } else {
                        // Mobile button
                        if (isActive) {
                            b.classList.add(
                                "bg-blue-600",
                                "text-white",
                                "shadow-md",
                            );
                            b.classList.remove(
                                "bg-white",
                                "border-slate-200",
                                "text-slate-500",
                            );
                        } else {
                            b.classList.remove(
                                "bg-blue-600",
                                "text-white",
                                "shadow-md",
                            );
                            b.classList.add(
                                "bg-white",
                                "border-slate-200",
                                "text-slate-500",
                            );
                        }
                    }
                });

                filterSymbols();
            });
        });
    </script>
</Layout>

<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
